name: Build RPM Package

on:
  release:
    types: [published]

# Security: Restrict permissions to minimum required
permissions:
  contents: write  # Required for release uploads
  id-token: write  # Required for SLSA attestation

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      
    - name: Set up Python
      uses: actions/setup-python@f677139bbe7f9c59b41e40162b753c062f5d49a3 # v5.2.0
      with:
        python-version: '3.10'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      
    - name: Install dependencies
      run: uv sync
      
    - name: Build wheel
      run: uv build --wheel

    - name: Install RPM build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y rpm rpm-build build-essential

    - name: Build RPM from wheel using alien
      run: |
        # Install alien for DEB to RPM conversion
        sudo apt-get install -y alien

        # First convert wheel to DEB using wheel2deb
        python3 -m pip install wheel2deb
        sudo apt-get install -y fakeroot build-essential devscripts debhelper apt-file
        sudo apt-file update || true

        mkdir -p deb_build
        wheel2deb convert -o deb_build dist/*.whl || true

        # Build DEB packages first
        for src_pkg in deb_build/*.dsc; do
          if [ -f "$src_pkg" ]; then
            pkg_dir=$(basename "$src_pkg" .dsc)
            cd "deb_build/$pkg_dir"
            dpkg-buildpackage -rfakeroot -uc -us || true
            cd ../..
          fi
        done

        # Convert DEB to RPM using alien
        mkdir -p dist_rpm
        for deb in deb_build/*.deb; do
          if [ -f "$deb" ]; then
            sudo alien -r -c -k "$deb" --target-version $(basename "$deb" | sed 's/.*_\([^-]*\)-.*/\1/') || true
          fi
        done

        # Move RPM files to dist directory
        find . -name "*.rpm" -type f -exec mv {} dist/ \; 2>/dev/null || true

    - name: Verify RPM files
      run: |
        ls -la dist/*.rpm 2>/dev/null || echo "No RPM files found"
        find . -name "*.rpm" -type f
        
    - name: Set up GPG
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        echo "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --yes --import
        # Create secure passphrase file
        echo "$GPG_PASSPHRASE" > /tmp/gpg_passphrase
        chmod 600 /tmp/gpg_passphrase
        # Configure GPG for non-interactive use
        mkdir -p ~/.gnupg
        echo "use-agent" >> ~/.gnupg/gpg.conf
        echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
        echo "batch" >> ~/.gnupg/gpg.conf
        echo "yes" >> ~/.gnupg/gpg.conf
        
    - name: Sign RPM packages
      run: |
        if [ ! -d dist ] || [ -z "$(find dist -name '*.rpm' -type f 2>/dev/null)" ]; then
          echo "No RPM files found to sign"
          mkdir -p dist
          exit 0
        fi

        # Configure RPM signing (optional, rpm signing may not work in container)
        for rpm in dist/*.rpm; do
          if [ -f "$rpm" ]; then
            # Create detached signature
            gpg --batch --yes --pinentry-mode loopback --passphrase-file /tmp/gpg_passphrase --armor --detach-sign "$rpm" || true
          fi
        done

    - name: Generate checksums
      run: |
        if [ ! -d dist ]; then
          mkdir -p dist
        fi

        cd dist

        if [ -z "$(find . -maxdepth 1 -name '*.rpm' -type f 2>/dev/null)" ]; then
          echo "No RPM files found for checksums"
          touch SHA256SUMS-RPM
          touch SHA256SUMS-RPM.sig
          exit 0
        fi

        sha256sum *.rpm *.rpm.asc > SHA256SUMS-RPM 2>/dev/null || sha256sum *.rpm > SHA256SUMS-RPM
        # Sign the checksums file
        gpg --batch --yes --pinentry-mode loopback --passphrase-file /tmp/gpg_passphrase --clearsign SHA256SUMS-RPM || true
        if [ -f SHA256SUMS-RPM.asc ]; then
          mv SHA256SUMS-RPM.asc SHA256SUMS-RPM.sig
        else
          cp SHA256SUMS-RPM SHA256SUMS-RPM.sig
        fi

    - name: Get package info
      id: package_info
      run: |
        VERSION="${{ github.event.release.tag_name }}"
        VERSION="${VERSION#v}"  # Remove 'v' prefix
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        if [ -f "dist/*.rpm" ]; then
          echo "package_name=$(ls dist/*.rpm 2>/dev/null | head -1 | xargs basename)" >> $GITHUB_OUTPUT
        else
          echo "package_name=sot-$VERSION.rpm" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload to Release
      uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
      with:
        files: |
          dist/*.rpm
          dist/*.rpm.asc
          dist/SHA256SUMS-RPM
          dist/SHA256SUMS-RPM.sig
        tag_name: ${{ github.event.release.tag_name }}
        generate_release_notes: false
        fail_on_unmatched_files: false
        append_body: true
        body: |

          ## ðŸ“¦ RPM Package
          - **Package**: `${{ steps.package_info.outputs.package_name }}`
          - **Version**: `${{ steps.package_info.outputs.version }}`
          - **Architecture**: x86_64
          - **Distribution**: EL8+
          - **GPG Signed**: âœ…

          ### Installation
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/${{ steps.package_info.outputs.package_name }}
          sudo rpm -ivh ${{ steps.package_info.outputs.package_name }}
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Cleanup sensitive files
      if: always()
      run: |
        rm -f /tmp/gpg_passphrase
        gpg-connect-agent killagent /bye || true
