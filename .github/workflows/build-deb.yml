name: Build DEB Package

on:
  release:
    types: [published]

# Security: Restrict permissions to minimum required
permissions:
  contents: write  # Required for release uploads
  id-token: write  # Required for SLSA attestation

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      
    - name: Set up Python
      uses: actions/setup-python@f677139bbe7f9c59b41e40162b753c062f5d49a3 # v5.2.0
      with:
        python-version: '3.10'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      
    - name: Install dependencies
      run: uv sync
      
    - name: Build wheel
      run: uv build --wheel

    - name: Install wheel2deb and signing tools
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-sig fakeroot build-essential devscripts debhelper apt-file
        python3 -m pip install wheel2deb

    - name: Update apt cache
      run: |
        sudo apt-file update || true

    - name: Convert wheel to deb
      run: |
        mkdir -p output
        wheel2deb convert --map "distro=distro" --map "py-cpuinfo=python3-cpuinfo" --map "psutil=python3-psutil" --map "rich=python3-rich" --map "textual=python3-textual" -o output dist/*.whl || true

    - name: Build deb packages
      run: |
        for src_pkg in output/*.dsc; do
          if [ -f "$src_pkg" ]; then
            pkg_dir=$(basename "$src_pkg" .dsc)
            cd "output/$pkg_dir"
            dpkg-buildpackage -rfakeroot -uc -us || true
            cd ../..
          fi
        done

    - name: Verify DEB files
      run: |
        ls -la output/*.deb 2>/dev/null || echo "No DEB files found in output/"
        ls -la output/*/ 2>/dev/null || echo "No subdirectories in output/"
        find output -name "*.deb" -type f
        
    - name: Set up GPG
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        echo "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --yes --import
        # Create secure passphrase file
        echo "$GPG_PASSPHRASE" > /tmp/gpg_passphrase
        chmod 600 /tmp/gpg_passphrase
        # Configure GPG for non-interactive use
        mkdir -p ~/.gnupg
        echo "use-agent" >> ~/.gnupg/gpg.conf
        echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
        echo "batch" >> ~/.gnupg/gpg.conf
        echo "yes" >> ~/.gnupg/gpg.conf
        
    - name: Sign DEB packages
      run: |
        if [ ! -d output ] || [ -z "$(find output -name '*.deb' -type f 2>/dev/null)" ]; then
          echo "No DEB files found to sign"
          mkdir -p output
          exit 0
        fi

        for deb in output/*.deb; do
          if [ -f "$deb" ]; then
            dpkg-sig --sign builder --gpg-options "--batch --yes --pinentry-mode loopback --passphrase-file /tmp/gpg_passphrase" "$deb" || true
            # Also create detached signature
            gpg --batch --yes --pinentry-mode loopback --passphrase-file /tmp/gpg_passphrase --armor --detach-sign "$deb" || true
          fi
        done

    - name: Generate checksums
      run: |
        if [ ! -d output ]; then
          mkdir -p output
        fi

        cd output

        if [ -z "$(find . -maxdepth 1 -name '*.deb' -type f 2>/dev/null)" ]; then
          echo "No DEB files found for checksums"
          touch SHA256SUMS
          touch SHA256SUMS.sig
          exit 0
        fi

        sha256sum *.deb *.deb.asc > SHA256SUMS 2>/dev/null || sha256sum *.deb > SHA256SUMS
        # Sign the checksums file
        gpg --batch --yes --pinentry-mode loopback --passphrase-file /tmp/gpg_passphrase --clearsign SHA256SUMS || true
        if [ -f SHA256SUMS.asc ]; then
          mv SHA256SUMS.asc SHA256SUMS.sig
        else
          cp SHA256SUMS SHA256SUMS.sig
        fi

    - name: Get package info
      id: package_info
      run: |
        VERSION="${{ github.event.release.tag_name }}"
        VERSION="${VERSION#v}"  # Remove 'v' prefix
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        if [ -f "output/*.deb" ]; then
          echo "package_name=$(ls output/*.deb 2>/dev/null | head -1 | xargs basename)" >> $GITHUB_OUTPUT
        else
          echo "package_name=sot-$VERSION.deb" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload to Release
      uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
      with:
        files: |
          output/*.deb
          output/*.deb.asc
          output/SHA256SUMS
          output/SHA256SUMS.sig
          .github/public-key.asc
        tag_name: ${{ github.event.release.tag_name }}
        generate_release_notes: false
        fail_on_unmatched_files: false
        append_body: true
        body: |

          ## ðŸ“¦ DEB Package
          - **Package**: `${{ steps.package_info.outputs.package_name }}`
          - **Version**: `${{ steps.package_info.outputs.version }}`
          - **Architecture**: AMD64
          - **GPG Signed**: âœ…

          ### Installation
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/${{ steps.package_info.outputs.package_name }}
          sudo dpkg -i ${{ steps.package_info.outputs.package_name }}
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Cleanup sensitive files
      if: always()
      run: |
        rm -f /tmp/gpg_passphrase
        gpg-connect-agent killagent /bye || true
