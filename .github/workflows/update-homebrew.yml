name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: release
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Fetch PyPI package info
        id: pypi
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          JSON=$(curl -sL "https://pypi.org/pypi/sot/$VERSION/json")

          # Extract source distribution URL and SHA256
          URL=$(echo "$JSON" | python3 -c "import sys, json; data=json.load(sys.stdin); urls=[u for u in data['urls'] if u['packagetype']=='sdist']; print(urls[0]['url'])")
          SHA256=$(echo "$JSON" | python3 -c "import sys, json; data=json.load(sys.stdin); urls=[u for u in data['urls'] if u['packagetype']=='sdist']; print(urls[0]['digests']['sha256'])")

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: Trigger homebrew-tools update
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.HOMEBREW_TAP_TOKEN }}" \
            https://api.github.com/repos/anistark/homebrew-tools/dispatches \
            -d '{
              "event_type": "update-formula",
              "client_payload": {
                "formula": "sot",
                "version": "${{ steps.release.outputs.version }}",
                "url": "${{ steps.pypi.outputs.url }}",
                "sha256": "${{ steps.pypi.outputs.sha256 }}"
              }
            }'
