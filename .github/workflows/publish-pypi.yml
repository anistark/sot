name: Publish to PyPI

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

# Security: Restrict permissions to minimum required
permissions:
  contents: read
  id-token: write  # Required for trusted publishing to PyPI

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      
    - name: Set up Python
      uses: actions/setup-python@f677139bbe7f9c59b41e40162b753c062f5d49a3 # v5.2.0
      with:
        python-version: '3.10'
        
    - name: Install uv
      uses: astral-sh/setup-uv@f2d60f03b23ce44c12b80ca600d6d94e20dbc855 # v4.1.1
      
    - name: Install dependencies
      run: uv sync
      
    - name: Build package
      run: uv build --sdist --wheel
      
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@f7600683efdcb7656dec5b29656edb7bc586e597 # v1.10.3
      with:
        print-hash: true
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        draft: true
        prerelease: false
        generate_release_notes: true
        files: |
          dist/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Trigger distribution builds
      uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3.0.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        event-type: build-distributions
        client-payload: '{"tag": "${{ github.ref_name }}"}'
